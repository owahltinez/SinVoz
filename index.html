<head>
  <title>SinVoz Speech Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="//unpkg.com/mancha@0.9" css="utils" init></script>
</head>

<body class="p-4" :data="{
  voices: [],
  settings: {
    page: 'settings',
    rate: 1,
    volume: 1,
    pitch: 1,
    voice: null,
  }
}">

  <template is="speech-button">
    <button class="px-4 py-2 bg-transparent hover:bg-gray-100" :on:click="s(text)">{{ text || 'custom' }}</button>
  </template>

  <h1>SinVoz Speech Helper</h1>
  <!-- Tabs for the different screens -->
  <nav class="flex flex-row gap-4">
    <button class="text-xl bg-transparent border-none" :on:click="setval('page', 'speech')">Speech</button>
    <button class="text-xl bg-transparent border-none" :on:click="setval('page', 'settings')">Settings</button>
  </nav>

  <!-- Horizontal line -->
  <hr class="my-4" />

  <section class="flex flex-col" :show="!settings.page.localeCompare('settings')">
    <h2>Settings</h2>

    <label class="flex flex-row">
      <span class="w-32">Rate: {{ settings.rate }}</span>
      <input class="w-full" type="range" min="0.1" max="10" step="0.1" :value="settings.rate"
        :on:input="setval('rate', parseFloat($event.target.value))" />
    </label>

    <label class="flex flex-row">
      <span class="w-32">Volume: {{ settings.volume }}</span>
      <input class="w-full" type="range" min="0" max="1" step="0.1" :value="settings.volume"
        :on:change="setval('volume', parseFloat($event.target.value))" />
    </label>

    <label class="flex flex-row">
      <span class="w-32">Pitch: {{ settings.pitch }}</span>
      <input class="w-full" type="range" min="0" max="2" step="0.1" :value="settings.pitch"
        :on:change="setval('pitch', parseFloat($event.target.value))" />
    </label>

    <label class="flex flex-row">
      <span class="w-32">Voice</span>
      <select id="voicesel" class="w-full" :value="settings.voice" :on:change="setval('voice', $event.target.value)">
        <option :for="voice in voices">{{ voice.name }}</option>
      </select>
    </label>
  </section>

  <div class="flex flex-wrap gap-4" :show="!settings.page.localeCompare('speech')">
    <speech-button :data="{ text: null }"></speech-button>
    <speech-button :data="{ text: 'yes' }"></speech-button>
    <speech-button :data="{ text: 'super yes' }"></speech-button>
    <speech-button :data="{ text: 'no' }"></speech-button>
    <speech-button :data="{ text: 'super no' }"></speech-button>
    <speech-button :data="{ text: 'agree' }"></speech-button>
    <speech-button :data="{ text: 'disagree' }"></speech-button>
    <speech-button :data="{ text: 'I pick the first one' }"></speech-button>
    <speech-button :data="{ text: 'I pick the last one' }"></speech-button>
    <speech-button :data="{ text: 'I do not care' }"></speech-button>
    <speech-button :data="{ text: 'you choose' }"></speech-button>
    <speech-button :data="{ text: 'look at this' }"></speech-button>
    <speech-button :data="{ text: 'we should leave' }"></speech-button>
  </div>
</body>

<script>

  const { $ } = Mancha;
  $.page = 'settings';

  // Create a global utterance object.
  const synth = new SpeechSynthesisUtterance();

  // When the voices are loaded, set the voice to the first one.
  window.speechSynthesis.onvoiceschanged = () => {
    $.voices = speechSynthesis.getVoices();

    // Load settings from local storage.
    $.settings = JSON.parse(localStorage.getItem('settings')) || $.settings;

    // Fallback to the default voice of none is set.
    // NOTE: We do this asynchromously to give the voices time to populate the selector.
    setTimeout(() => $.settings.voice = $.settings.voice || $.voices[0].name, 100);
  };

  $.setval = function (key, value) {
    $.settings[key] = value;
    localStorage.setItem('settings', JSON.stringify($.settings));
  };

  $.llm = async function (text) {
    const url = new URL(`https://functions.fresho.workers.dev/genai/completion.txt`);
    const prompt = `Come up with a createive and snarky way of saying "${text}" in less than 10 words. Keep it simple and feel free to use expelletives.`;
    url.searchParams.append('prompt', prompt);
    url.searchParams.append('provider', 'openai');
    const res = await fetch(url);
    if (res.ok) return res.text();
    console.log('Failed to fetch from API');
    return text;
  }

  $.s = async function (text) {
    if (!text) text = prompt('Enter the text to speak');
    console.log('speaking', text);
    const speech = await $.llm(text);

    // If there is an active speech synthesis, stop it.
    if (window.speechSynthesis.speaking) {
      window.speechSynthesis.cancel();
    }
    // Create a new speech synthesis.
    const synth = new SpeechSynthesisUtterance(speech);

    // Apply global settings.
    synth.rate = $.settings.rate;
    synth.volume = $.settings.volume;
    synth.pitch = $.settings.pitch;
    synth.voice = $.voices.find(voice => voice.name === $.settings.voice) || $.voices[0];
    console.log(synth);

    // Start the speech synthesis.
    window.speechSynthesis.speak(synth);
  };
</script>